<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#2c3e50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Mobile CIF file viewer with touch controls - PWA">
    <title>KLayout Mobile - CIF Viewer</title>
    
    <!-- Inline PWA Manifest -->
    <link rel="manifest" id="manifest-placeholder">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%232c3e50'/%3E%3Ccircle cx='64' cy='64' r='40' fill='%233498db'/%3E%3Ccircle cx='64' cy='64' r='20' fill='%232ecc71'/%3E%3C/svg%3E">
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='22' fill='%232c3e50'/%3E%3Ccircle cx='24' cy='24' r='15' fill='%233498db'/%3E%3Ccircle cx='24' cy='24' r='8' fill='%232ecc71'/%3E%3C/svg%3E">
    
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
        }

        /* Mobile-first Layout */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
            max-width: 100vw;
        }

        /* Top Header Bar */
        .header {
            background: #2c3e50;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: 60px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .header-controls {
            display: flex;
            gap: 10px;
        }

        /* Main Canvas Area */
        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #121212;
            touch-action: none;
        }

        #cif-canvas {
            display: block;
            width: 100%;
            height: 100%;
            background: #121212;
        }

        /* Bottom Controls - Mobile Optimized */
        .bottom-controls {
            background: #2c3e50;
            padding: 16px;
            display: flex;
            gap: 16px;
            justify-content: space-around;
            min-height: 80px;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        }

        .control-button {
            flex: 1;
            min-width: 0;
            min-height: 56px;
            background: #34495e;
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            cursor: pointer;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .control-button:active {
            background: #3498db;
            transform: scale(0.95);
        }

        .control-button .icon {
            font-size: 20px;
            margin-bottom: 2px;
        }

        .control-button .label {
            font-size: 12px;
            opacity: 0.9;
        }

        .control-button.install-button {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            animation: pulse 2s infinite;
        }

        .control-button.install-button:active {
            background: linear-gradient(135deg, #27ae60, #219653);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        /* Bottom Sheet for Layers */
        .bottom-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2c3e50;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .bottom-sheet.open {
            transform: translateY(0);
        }

        .sheet-handle {
            width: 40px;
            height: 4px;
            background: rgba(255,255,255,0.3);
            border-radius: 2px;
            margin: 12px auto;
        }

        .sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 20px;
            -webkit-overflow-scrolling: touch;
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-top: 10px;
        }

        .sheet-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
        }

        .close-sheet {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #34495e;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* Layer List */
        .layer-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #34495e;
            border-radius: 10px;
            min-height: 60px;
        }

        .layer-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            margin-right: 12px;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .layer-info {
            flex: 1;
        }

        .layer-name {
            font-weight: 500;
            margin-bottom: 2px;
        }

        .layer-stats {
            font-size: 12px;
            opacity: 0.7;
        }

        .layer-toggle {
            width: 44px;
            height: 24px;
            border-radius: 12px;
            background: #7f8c8d;
            position: relative;
            transition: background 0.3s;
            cursor: pointer;
            margin-left: 10px;
        }

        .layer-toggle.active {
            background: #2ecc71;
        }

        .layer-toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }

        .layer-toggle.active::after {
            transform: translateX(20px);
        }

        /* Install PWA Banner */
        .install-banner {
            position: fixed;
            bottom: 90px;
            left: 20px;
            right: 20px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 999;
            transform: translateY(150%);
            transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .install-banner.show {
            transform: translateY(0);
        }

        .install-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #3498db, #2ecc71);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            flex-shrink: 0;
        }

        .install-text {
            flex: 1;
        }

        .install-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: white;
        }

        .install-description {
            font-size: 13px;
            opacity: 0.8;
        }

        .install-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .install-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .install-primary {
            background: #2ecc71;
            color: white;
        }

        .install-secondary {
            background: transparent;
            color: #3498db;
            border: 2px solid #3498db;
        }

        /* File Info Panel */
        .file-info-panel {
            background: #34495e;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        /* Touch Instructions Overlay */
        .touch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s;
        }

        .touch-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .touch-demo {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            max-width: 400px;
        }

        .touch-gesture {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .gesture-icon {
            width: 80px;
            height: 80px;
            background: rgba(52, 152, 219, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 36px;
        }

        .gesture-text {
            font-size: 16px;
            color: white;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Fullscreen Mode */
        .fullscreen .header,
        .fullscreen .bottom-controls {
            display: none;
        }

        .fullscreen-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 44px;
            height: 44px;
            background: rgba(44, 62, 80, 0.8);
            border-radius: 22px;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Coordinate Display */
        .coordinate-display {
            position: absolute;
            bottom: 90px;
            left: 20px;
            background: rgba(44, 62, 80, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* Grid Toggle */
        .grid-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 44px;
            height: 44px;
            background: rgba(44, 62, 80, 0.8);
            border-radius: 22px;
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 50;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* File Drop Zone */
        .drop-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(52, 152, 219, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1002;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .drop-zone.active {
            opacity: 1;
            pointer-events: all;
        }

        .drop-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        /* Zoom Level Indicator */
        .zoom-indicator {
            position: absolute;
            top: 80px;
            right: 20px;
            background: rgba(44, 62, 80, 0.8);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        /* PWA Install Instructions */
        .pwa-instructions {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        .pwa-instructions.show {
            opacity: 1;
            pointer-events: all;
        }

        .instructions-content {
            max-width: 500px;
            background: #2c3e50;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .instructions-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .instructions-header h2 {
            font-size: 24px;
            margin-bottom: 10px;
            color: white;
        }

        .instructions-steps {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        /* Responsive Adjustments */
        @media (min-width: 768px) {
            .control-button {
                max-width: 200px;
            }
            
            .bottom-sheet {
                max-width: 500px;
                left: 50%;
                transform: translate(-50%, 100%);
                border-radius: 20px;
            }
            
            .bottom-sheet.open {
                transform: translate(-50%, 0);
            }
            
            .install-banner {
                max-width: 500px;
                left: 50%;
                transform: translate(-50%, 150%);
            }
            
            .install-banner.show {
                transform: translate(-50%, 0);
            }
        }

        @media (orientation: landscape) {
            .app-container {
                flex-direction: row;
            }
            
            .header {
                flex-direction: column;
                width: 80px;
                padding: 16px 8px;
                justify-content: flex-start;
            }
            
            .logo {
                flex-direction: column;
                margin-bottom: 20px;
            }
            
            .header-controls {
                flex-direction: column;
            }
            
            .bottom-controls {
                flex-direction: column;
                width: 80px;
                min-height: auto;
                padding: 16px 8px;
            }
            
            .control-button {
                min-height: 70px;
            }
            
            .install-banner {
                bottom: 20px;
                left: 100px;
                right: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container" id="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">K</div>
                <div class="logo-text">KLayout Mobile</div>
            </div>
            <div class="header-controls">
                <button class="control-button" id="btn-open-file">
                    <span class="icon">üìÅ</span>
                    <span class="label">Open</span>
                </button>
                <button class="control-button" id="btn-fullscreen">
                    <span class="icon">üî≤</span>
                    <span class="label">Fullscreen</span>
                </button>
            </div>
        </header>

        <!-- Main Canvas -->
        <div class="canvas-container">
            <canvas id="cif-canvas"></canvas>
            
            <!-- Floating Controls -->
            <button class="grid-toggle" id="btn-toggle-grid" title="Toggle Grid">
                ‚èπÔ∏è
            </button>
            <button class="fullscreen-toggle" id="btn-toggle-fullscreen" style="display: none;">
                üî≤
            </button>
            <div class="coordinate-display" id="coordinate-display">
                X: 0.00, Y: 0.00
            </div>
            <div class="zoom-indicator" id="zoom-indicator">
                Zoom: 100%
            </div>
            
            <!-- Drop Zone -->
            <div class="drop-zone" id="drop-zone">
                <div class="drop-icon">üìÅ</div>
                <div style="font-size: 24px; margin-bottom: 10px;">Drop CIF File</div>
                <div style="opacity: 0.8;">Release to view the file</div>
            </div>
            
            <!-- Loading Overlay -->
            <div class="loading-overlay" id="loading-overlay" style="display: none;">
                <div class="spinner"></div>
                <div>Processing CIF file...</div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="bottom-controls">
            <button class="control-button" id="btn-layers">
                <span class="icon">üìä</span>
                <span class="label">Layers</span>
            </button>
            <button class="control-button" id="btn-fit-view">
                <span class="icon">‚è±Ô∏è</span>
                <span class="label">Fit View</span>
            </button>
            <button class="control-button" id="btn-install-pwa">
                <span class="icon">üì±</span>
                <span class="label">Install App</span>
            </button>
            <button class="control-button" id="btn-help">
                <span class="icon">‚ùì</span>
                <span class="label">Help</span>
            </button>
        </div>

        <!-- PWA Install Banner -->
        <div class="install-banner" id="install-banner">
            <div class="install-icon">üì±</div>
            <div class="install-text">
                <div class="install-title">Install KLayout Mobile</div>
                <div class="install-description">Get full app experience with offline access</div>
                <div class="install-actions">
                    <button class="install-btn install-primary" id="btn-install-now">Install Now</button>
                    <button class="install-btn install-secondary" id="btn-install-later">Later</button>
                </div>
            </div>
        </div>

        <!-- Bottom Sheet for Layers -->
        <div class="bottom-sheet" id="layer-sheet">
            <div class="sheet-handle"></div>
            <div class="sheet-content">
                <div class="sheet-header">
                    <div class="sheet-title">Layer Controls</div>
                    <button class="close-sheet" id="btn-close-sheet">‚úï</button>
                </div>
                
                <div class="layer-list" id="layer-list">
                    <!-- Layers will be dynamically added here -->
                </div>
                
                <div class="file-info-panel" id="file-info-panel" style="display: none;">
                    <div class="info-item">
                        <span>File:</span>
                        <span id="file-name">None</span>
                    </div>
                    <div class="info-item">
                        <span>Objects:</span>
                        <span id="total-objects">0</span>
                    </div>
                    <div class="info-item">
                        <span>Layers:</span>
                        <span id="total-layers">0</span>
                    </div>
                    <div class="info-item">
                        <span>Zoom:</span>
                        <span id="current-zoom">100%</span>
                    </div>
                    <div class="info-item">
                        <span>App Mode:</span>
                        <span id="app-mode">Browser</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Touch Instructions Overlay -->
        <div class="touch-overlay" id="touch-overlay">
            <div class="touch-demo">
                <div class="touch-gesture">
                    <div class="gesture-icon">üëÜ</div>
                    <div class="gesture-text">One finger drag to pan</div>
                </div>
                <div class="touch-gesture">
                    <div class="gesture-icon">ü§è</div>
                    <div class="gesture-text">Pinch to zoom in/out</div>
                </div>
                <div class="touch-gesture">
                    <div class="gesture-icon">üëÜüëÜ</div>
                    <div class="gesture-text">Double tap to fit view</div>
                </div>
                <button class="control-button" id="btn-got-it" style="max-width: 200px; margin-top: 20px;">
                    <span class="label">Got it!</span>
                </button>
            </div>
        </div>

        <!-- PWA Install Instructions -->
        <div class="pwa-instructions" id="pwa-instructions">
            <div class="instructions-content">
                <div class="instructions-header">
                    <h2>How to Install</h2>
                    <p>Follow these steps to install KLayout Mobile as an app:</p>
                </div>
                <div class="instructions-steps" id="instructions-steps">
                    <!-- Dynamic instructions based on platform -->
                </div>
                <div class="install-actions" style="justify-content: center;">
                    <button class="install-btn install-primary" id="btn-close-instructions">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden File Input -->
    <input type="file" id="file-input" accept=".cif" style="display: none;">

    <script>
        // Mobile-optimized CIF Viewer Application with PWA Installation
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const canvas = document.getElementById('cif-canvas');
            const ctx = canvas.getContext('2d');
            const appContainer = document.getElementById('app-container');
            const layerSheet = document.getElementById('layer-sheet');
            const touchOverlay = document.getElementById('touch-overlay');
            const loadingOverlay = document.getElementById('loading-overlay');
            const dropZone = document.getElementById('drop-zone');
            const installBanner = document.getElementById('install-banner');
            const pwaInstructions = document.getElementById('pwa-instructions');
            const fileInput = document.getElementById('file-input');
            
            // PWA Installation Variables
            let deferredPrompt = null;
            let isPWAInstalled = false;
            let isStandalone = false;
            
            // State Management
            let cifData = null;
            let layers = [];
            let activeLayers = new Set();
            let showGrid = true;
            let isFullscreen = false;
            let lastTouchDistance = 0;
            let initialPinchCenter = null;
            
            // Viewport State
            let offsetX = 0;
            let offsetY = 0;
            let scale = 1.0;
            let minScale = 0.01;
            let maxScale = 50.0;
            let canvasWidth = 0;
            let canvasHeight = 0;
            let boundingBox = { minX: 0, maxX: 0, minY: 0, maxY: 0 };
            
            // Touch Tracking
            let activeTouches = new Map();
            let lastTapTime = 0;
            let isDragging = false;
            
            // Color Palette
            const layerColors = [
                '#ff6b6b', '#4ecdc4', '#ffe66d', '#1a936f', '#ff9a00',
                '#9d4edd', '#00bbf9', '#f15bb5', '#00f5d4', '#ff6d00',
                '#a663cc', '#6a994e', '#ee6c4d', '#118ab2', '#06d6a0'
            ];
            
            // Initialize Application
            function init() {
                setupCanvas();
                setupEventListeners();
                setupUI();
                setupPWA();
                checkFirstTimeUser();
                
                // Load sample data for demo
                setTimeout(loadSampleData, 1000);
            }
            
            function setupCanvas() {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.parentElement.getBoundingClientRect();
                
                canvasWidth = rect.width;
                canvasHeight = rect.height;
                
                // Set canvas size with device pixel ratio for retina displays
                canvas.width = canvasWidth * dpr;
                canvas.height = canvasHeight * dpr;
                ctx.scale(dpr, dpr);
                
                draw();
            }
            
            function setupEventListeners() {
                // File handling
                document.getElementById('btn-open-file').addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileSelect);
                
                // UI Controls
                document.getElementById('btn-layers').addEventListener('click', toggleLayerSheet);
                document.getElementById('btn-close-sheet').addEventListener('click', toggleLayerSheet);
                document.getElementById('btn-fit-view').addEventListener('click', fitToScreen);
                document.getElementById('btn-help').addEventListener('click', showHelp);
                document.getElementById('btn-got-it').addEventListener('click', hideHelp);
                document.getElementById('btn-toggle-grid').addEventListener('click', toggleGrid);
                document.getElementById('btn-fullscreen').addEventListener('click', toggleFullscreen);
                document.getElementById('btn-toggle-fullscreen').addEventListener('click', toggleFullscreen);
                
                // PWA Installation
                document.getElementById('btn-install-pwa').addEventListener('click', showPWAInstructions);
                document.getElementById('btn-install-now').addEventListener('click', installPWA);
                document.getElementById('btn-install-later').addEventListener('click', hideInstallBanner);
                document.getElementById('btn-close-instructions').addEventListener('click', () => {
                    pwaInstructions.classList.remove('show');
                });
                
                // Touch events for canvas
                canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
                canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
                canvas.addEventListener('touchend', handleTouchEnd);
                canvas.addEventListener('touchcancel', handleTouchEnd);
                
                // Mouse events (for desktop/tablet compatibility)
                canvas.addEventListener('mousedown', handleMouseDown);
                canvas.addEventListener('mousemove', handleMouseMove);
                canvas.addEventListener('mouseup', handleMouseUp);
                canvas.addEventListener('wheel', handleWheel, { passive: false });
                
                // Double tap detection
                canvas.addEventListener('click', handleCanvasClick);
                
                // Drag and drop
                canvas.addEventListener('dragover', handleDragOver);
                canvas.addEventListener('dragleave', handleDragLeave);
                canvas.addEventListener('drop', handleDrop);
                
                // Fullscreen API
                document.addEventListener('fullscreenchange', handleFullscreenChange);
                document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
                
                // Window resize
                window.addEventListener('resize', handleResize);
                window.addEventListener('orientationchange', handleResize);
                
                // PWA Installation Events
                window.addEventListener('beforeinstallprompt', handleBeforeInstallPrompt);
                window.addEventListener('appinstalled', handleAppInstalled);
            }
            
            function setupUI() {
                // Update coordinate display on mouse move
                canvas.addEventListener('mousemove', updateCoordinateDisplay);
                canvas.addEventListener('touchmove', updateCoordinateDisplay);
                
                // Check if already in standalone mode (PWA installed)
                checkPWAStatus();
            }
            
            function setupPWA() {
                // Set up inline manifest
                const manifest = {
                    "name": "KLayout Mobile CIF Viewer",
                    "short_name": "KLayout Mobile",
                    "description": "Mobile CIF file viewer with touch controls",
                    "theme_color": "#2c3e50",
                    "background_color": "#1a1a1a",
                    "display": "standalone",
                    "orientation": "any",
                    "scope": "/",
                    "start_url": ".",
                    "icons": [
                        {
                            "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Ccircle cx='24' cy='24' r='22' fill='%232c3e50'/%3E%3Ccircle cx='24' cy='24' r='15' fill='%233498db'/%3E%3Ccircle cx='24' cy='24' r='8' fill='%232ecc71'/%3E%3C/svg%3E",
                            "sizes": "48x48",
                            "type": "image/svg+xml"
                        },
                        {
                            "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'%3E%3Ccircle cx='64' cy='64' r='60' fill='%232c3e50'/%3E%3Ccircle cx='64' cy='64' r='40' fill='%233498db'/%3E%3Ccircle cx='64' cy='64' r='20' fill='%232ecc71'/%3E%3C/svg%3E",
                            "sizes": "128x128",
                            "type": "image/svg+xml"
                        },
                        {
                            "src": "data:image/svg+xml,%3Csvg xmlns='http.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Ccircle cx='96' cy='96' r='90' fill='%232c3e50'/%3E%3Ccircle cx='96' cy='96' r='60' fill='%233498db'/%3E%3Ccircle cx='96' cy='96' r='30' fill='%232ecc71'/%3E%3C/svg%3E",
                            "sizes": "192x192",
                            "type": "image/svg+xml"
                        },
                        {
                            "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Ccircle cx='256' cy='256' r='240' fill='%232c3e50'/%3E%3Ccircle cx='256' cy='256' r='160' fill='%233498db'/%3E%3Ccircle cx='256' cy='256' r='80' fill='%232ecc71'/%3E%3C/svg%3E",
                            "sizes": "512x512",
                            "type": "image/svg+xml"
                        }
                    ]
                };
                
                // Create a blob URL for the manifest
                const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
                const manifestURL = URL.createObjectURL(manifestBlob);
                
                // Set the manifest link
                const manifestLink = document.getElementById('manifest-placeholder');
                manifestLink.href = manifestURL;
                
                // Register service worker for PWA functionality
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        const CACHE_NAME = 'klayout-mobile-v2';
                        const urlsToCache = ['.'];

                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME)
                                    .then(cache => cache.addAll(urlsToCache))
                            );
                        });

                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request)
                                    .then(response => response || fetch(event.request))
                            );
                        });

                        self.addEventListener('activate', event => {
                            event.waitUntil(
                                caches.keys().then(cacheNames => {
                                    return Promise.all(
                                        cacheNames.map(cacheName => {
                                            if (cacheName !== CACHE_NAME) {
                                                return caches.delete(cacheName);
                                            }
                                        })
                                    );
                                })
                            );
                        });
                    `;
                    
                    const swBlob = new Blob([swCode], {type: 'application/javascript'});
                    const swURL = URL.createObjectURL(swBlob);
                    
                    navigator.serviceWorker.register(swURL)
                        .then(registration => {
                            console.log('ServiceWorker registration successful');
                        })
                        .catch(error => {
                            console.log('ServiceWorker registration failed:', error);
                        });
                }
            }
            
            // PWA Installation Functions
            function handleBeforeInstallPrompt(e) {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                
                // Stash the event so it can be triggered later
                deferredPrompt = e;
                
                // Update UI to notify the user they can install the PWA
                console.log('PWA installation available');
                
                // Show install banner after a delay
                setTimeout(() => {
                    if (!isPWAInstalled && !isStandalone) {
                        showInstallBanner();
                    }
                }, 3000);
            }
            
            function handleAppInstalled() {
                console.log('PWA was installed');
                isPWAInstalled = true;
                deferredPrompt = null;
                hideInstallBanner();
                
                // Update app mode display
                document.getElementById('app-mode').textContent = 'Installed PWA';
                
                // Show confirmation
                showToast('App installed successfully!');
            }
            
            function checkPWAStatus() {
                // Check if the app is running in standalone mode
                isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                              window.navigator.standalone || 
                              document.referrer.includes('android-app://');
                
                if (isStandalone) {
                    console.log('Running as installed PWA');
                    isPWAInstalled = true;
                    document.getElementById('app-mode').textContent = 'PWA Mode';
                    
                    // Hide install button when already installed
                    document.getElementById('btn-install-pwa').style.display = 'none';
                }
            }
            
            function showInstallBanner() {
                // Don't show if already installed or in standalone mode
                if (isPWAInstalled || isStandalone) return;
                
                // Check if banner was recently dismissed
                const bannerDismissed = localStorage.getItem('klayout-install-banner-dismissed');
                if (bannerDismissed) {
                    const dismissTime = parseInt(bannerDismissed);
                    const now = Date.now();
                    const oneDay = 24 * 60 * 60 * 1000;
                    
                    // Only show again after 7 days
                    if (now - dismissTime < 7 * oneDay) {
                        return;
                    }
                }
                
                installBanner.classList.add('show');
            }
            
            function hideInstallBanner() {
                installBanner.classList.remove('show');
                
                // Remember dismissal for 7 days
                localStorage.setItem('klayout-install-banner-dismissed', Date.now().toString());
            }
            
            async function installPWA() {
                if (!deferredPrompt) {
                    // If deferredPrompt is not available, show instructions
                    showPWAInstructions();
                    return;
                }
                
                // Show the install prompt
                deferredPrompt.prompt();
                
                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                    showToast('Installing app...');
                } else {
                    console.log('User dismissed the install prompt');
                    showToast('Installation cancelled');
                }
                
                // Clear the deferredPrompt variable
                deferredPrompt = null;
                
                // Hide the banner
                hideInstallBanner();
            }
            
            function showPWAInstructions() {
                const instructionsContainer = document.getElementById('instructions-steps');
                instructionsContainer.innerHTML = '';
                
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                const isAndroid = /Android/.test(navigator.userAgent);
                const isChrome = /Chrome/.test(navigator.userAgent) && !/Edge/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
                
                let steps = [];
                
                if (isIOS && isSafari) {
                    steps = [
                        {
                            number: "1",
                            text: "Tap the Share button at the bottom of the screen (the square with an arrow pointing up)"
                        },
                        {
                            number: "2",
                            text: "Scroll down and tap 'Add to Home Screen'"
                        },
                        {
                            number: "3",
                            text: "Tap 'Add' in the top right corner"
                        },
                        {
                            number: "4",
                            text: "The app will now appear on your home screen"
                        }
                    ];
                } else if (isAndroid && isChrome) {
                    steps = [
                        {
                            number: "1",
                            text: "Tap the three-dot menu in the top right corner"
                        },
                        {
                            number: "2",
                            text: "Select 'Install app' or 'Add to Home screen'"
                        },
                        {
                            number: "3",
                            text: "Tap 'Install' in the popup dialog"
                        },
                        {
                            number: "4",
                            text: "The app will install and appear on your home screen"
                        }
                    ];
                } else {
                    steps = [
                        {
                            number: "1",
                            text: "Look for the install icon in your browser's address bar"
                        },
                        {
                            number: "2",
                            text: "Click the install icon or look for 'Install' in the browser menu"
                        },
                        {
                            number: "3",
                            text: "Follow the prompts to install the app"
                        },
                        {
                            number: "4",
                            text: "The app will be added to your home screen or app list"
                        }
                    ];
                }
                
                // Add platform-specific note
                if (isIOS) {
                    steps.push({
                        number: "‚ÑπÔ∏è",
                        text: "Note: On iOS, you must use Safari browser to install PWAs"
                    });
                }
                
                // Render steps
                steps.forEach(step => {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'step';
                    stepElement.innerHTML = `
                        <div class="step-number">${step.number}</div>
                        <div style="flex: 1; font-size: 14px; line-height: 1.4;">${step.text}</div>
                    `;
                    instructionsContainer.appendChild(stepElement);
                });
                
                pwaInstructions.classList.add('show');
            }
            
            function showToast(message) {
                // Create toast element
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 150px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: #2c3e50;
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    z-index: 3000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    font-weight: 500;
                    opacity: 0;
                    transition: opacity 0.3s;
                `;
                
                document.body.appendChild(toast);
                
                // Fade in
                setTimeout(() => {
                    toast.style.opacity = '1';
                }, 10);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    toast.style.opacity = '0';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // Touch Event Handlers (remain the same as before)
            function handleTouchStart(e) {
                e.preventDefault();
                const touches = Array.from(e.touches);
                
                touches.forEach(touch => {
                    activeTouches.set(touch.identifier, {
                        x: touch.clientX,
                        y: touch.clientY,
                        startX: touch.clientX,
                        startY: touch.clientY,
                        time: Date.now()
                    });
                });
                
                if (touches.length === 1) {
                    isDragging = true;
                    const touch = touches[0];
                    const touchData = activeTouches.get(touch.identifier);
                    
                    const currentTime = Date.now();
                    if (currentTime - lastTapTime < 300 && 
                        Math.abs(touchData.x - touchData.startX) < 10 &&
                        Math.abs(touchData.y - touchData.startY) < 10) {
                        fitToScreen();
                        lastTapTime = 0;
                    } else {
                        lastTapTime = currentTime;
                    }
                }
                else if (touches.length === 2) {
                    const touch1 = touches[0];
                    const touch2 = touches[1];
                    
                    lastTouchDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    initialPinchCenter = {
                        x: (touch1.clientX + touch2.clientX) / 2,
                        y: (touch1.clientY + touch2.clientY) / 2
                    };
                }
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                const touches = Array.from(e.touches);
                
                if (touches.length === 1 && isDragging) {
                    const touch = touches[0];
                    const touchData = activeTouches.get(touch.identifier);
                    
                    if (touchData) {
                        const deltaX = touch.clientX - touchData.x;
                        const deltaY = touch.clientY - touchData.y;
                        
                        offsetX += deltaX / scale;
                        offsetY += deltaY / scale;
                        
                        touchData.x = touch.clientX;
                        touchData.y = touch.clientY;
                        
                        draw();
                    }
                }
                else if (touches.length === 2) {
                    const touch1 = touches[0];
                    const touch2 = touches[1];
                    
                    const currentDistance = Math.hypot(
                        touch2.clientX - touch1.clientX,
                        touch2.clientY - touch1.clientY
                    );
                    
                    if (lastTouchDistance > 0) {
                        const zoomFactor = currentDistance / lastTouchDistance;
                        const newScale = scale * zoomFactor;
                        
                        scale = Math.max(minScale, Math.min(maxScale, newScale));
                        
                        const centerX = (touch1.clientX + touch2.clientX) / 2;
                        const centerY = (touch1.clientY + touch2.clientY) / 2;
                        
                        const rect = canvas.getBoundingClientRect();
                        const worldX = (centerX - rect.left - canvasWidth/2) / scale - offsetX;
                        const worldY = (centerY - rect.top - canvasHeight/2) / scale - offsetY;
                        
                        const newWorldX = (centerX - rect.left - canvasWidth/2) / newScale - offsetX;
                        const newWorldY = (centerY - rect.top - canvasHeight/2) / newScale - offsetY;
                        
                        offsetX += newWorldX - worldX;
                        offsetY += newWorldY - worldY;
                        
                        draw();
                    }
                    
                    lastTouchDistance = currentDistance;
                }
                
                touches.forEach(touch => {
                    const touchData = activeTouches.get(touch.identifier);
                    if (touchData) {
                        touchData.x = touch.clientX;
                        touchData.y = touch.clientY;
                    }
                });
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                const endedTouches = Array.from(e.changedTouches);
                
                endedTouches.forEach(touch => {
                    activeTouches.delete(touch.identifier);
                });
                
                if (activeTouches.size === 0) {
                    isDragging = false;
                    lastTouchDistance = 0;
                    initialPinchCenter = null;
                }
            }
            
            // Mouse Event Handlers (remain the same)
            function handleMouseDown(e) {
                e.preventDefault();
                isDragging = true;
                
                activeTouches.set('mouse', {
                    x: e.clientX,
                    y: e.clientY,
                    startX: e.clientX,
                    startY: e.clientY,
                    time: Date.now()
                });
            }
            
            function handleMouseMove(e) {
                if (isDragging) {
                    e.preventDefault();
                    const touchData = activeTouches.get('mouse');
                    
                    if (touchData) {
                        const deltaX = e.clientX - touchData.x;
                        const deltaY = e.clientY - touchData.y;
                        
                        offsetX += deltaX / scale;
                        offsetY += deltaY / scale;
                        
                        touchData.x = e.clientX;
                        touchData.y = e.clientY;
                        
                        draw();
                    }
                }
            }
            
            function handleMouseUp() {
                isDragging = false;
                activeTouches.delete('mouse');
            }
            
            function handleWheel(e) {
                e.preventDefault();
                
                const zoomFactor = 0.1;
                const delta = e.deltaY > 0 ? -1 : 1;
                const newScale = scale * (1 + delta * zoomFactor);
                
                scale = Math.max(minScale, Math.min(maxScale, newScale));
                
                const rect = canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                const worldX = (mouseX - canvasWidth/2) / scale - offsetX;
                const worldY = (mouseY - canvasHeight/2) / scale - offsetY;
                
                const newWorldX = (mouseX - canvasWidth/2) / newScale - offsetX;
                const newWorldY = (mouseY - canvasHeight/2) / newScale - offsetY;
                
                offsetX += newWorldX - worldX;
                offsetY += newWorldY - worldY;
                
                draw();
            }
            
            function handleCanvasClick(e) {
                const currentTime = Date.now();
                if (currentTime - lastTapTime < 300) {
                    fitToScreen();
                    lastTapTime = 0;
                } else {
                    lastTapTime = currentTime;
                }
            }
            
            // File Handling (remain the same)
            function handleFileSelect(e) {
                const file = e.target.files[0];
                if (file && file.name.endsWith('.cif')) {
                    loadCIFFile(file);
                }
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                dropZone.classList.add('active');
            }
            
            function handleDragLeave() {
                dropZone.classList.remove('active');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                dropZone.classList.remove('active');
                
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith('.cif')) {
                    loadCIFFile(file);
                }
            }
            
            async function loadCIFFile(file) {
                loadingOverlay.style.display = 'flex';
                
                try {
                    const content = await readFileAsText(file);
                    parseCIF(content, file.name);
                } catch (error) {
                    alert('Error loading file: ' + error.message);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
            
            function readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(new Error('Failed to read file'));
                    reader.readAsText(file);
                });
            }
            
            // CIF Parser (remain the same)
            function parseCIF(content, fileName) {
                cifData = [];
                layers = [];
                activeLayers.clear();
                boundingBox = { minX: Infinity, maxX: -Infinity, minY: Infinity, maxY: -Infinity };
                
                let currentLayer = null;
                let layerId = 0;
                
                const lines = content.split('\n');
                const chunkSize = 1000;
                
                const processChunk = (start) => {
                    const end = Math.min(start + chunkSize, lines.length);
                    
                    for (let i = start; i < end; i++) {
                        parseCIFLine(lines[i], i + 1);
                    }
                    
                    if (end < lines.length) {
                        setTimeout(() => processChunk(end), 0);
                    } else {
                        finishParsing(fileName);
                    }
                };
                
                processChunk(0);
                
                function parseCIFLine(line, lineNumber) {
                    line = line.trim();
                    if (!line || line.startsWith('#')) return;
                    
                    const parts = line.split(';').filter(p => p.trim());
                    
                    for (let part of parts) {
                        part = part.trim();
                        const firstChar = part.charAt(0);
                        
                        switch (firstChar) {
                            case 'L':
                                const layerMatch = part.match(/L\s+(\S+)/);
                                if (layerMatch) {
                                    currentLayer = {
                                        id: layerId++,
                                        name: layerMatch[1],
                                        objects: []
                                    };
                                    layers.push(currentLayer);
                                    activeLayers.add(currentLayer.id);
                                }
                                break;
                                
                            case 'B':
                                const boxMatch = part.match(/B\s+(\d+)\s+(\d+)\s+(\d+)\s+(\d+)/);
                                if (boxMatch && currentLayer) {
                                    const width = parseInt(boxMatch[1]);
                                    const height = parseInt(boxMatch[2]);
                                    const x = parseInt(boxMatch[3]);
                                    const y = parseInt(boxMatch[4]);
                                    
                                    currentLayer.objects.push({
                                        type: 'B',
                                        x, y, width, height
                                    });
                                    
                                    updateBoundingBox(x, y);
                                    updateBoundingBox(x + width, y + height);
                                }
                                break;
                                
                            case 'P':
                                const polyMatch = part.match(/P\s+(\d+)((?:\s+\d+){6,})/);
                                if (polyMatch && currentLayer) {
                                    const pointCount = parseInt(polyMatch[1]);
                                    const coords = polyMatch[2].trim().split(/\s+/).map(Number);
                                    
                                    const points = [];
                                    for (let i = 0; i < pointCount * 2; i += 2) {
                                        points.push({ x: coords[i], y: coords[i+1] });
                                        updateBoundingBox(coords[i], coords[i+1]);
                                    }
                                    
                                    currentLayer.objects.push({
                                        type: 'P',
                                        points
                                    });
                                }
                                break;
                                
                            case 'W':
                                const wireMatch = part.match(/W\s+(\d+)((?:\s+\d+){4,})/);
                                if (wireMatch && currentLayer) {
                                    const pointCount = parseInt(wireMatch[1]);
                                    const coords = wireMatch[2].trim().split(/\s+/).map(Number);
                                    
                                    const points = [];
                                    for (let i = 0; i < pointCount * 2; i += 2) {
                                        points.push({ x: coords[i], y: coords[i+1] });
                                        updateBoundingBox(coords[i], coords[i+1]);
                                    }
                                    
                                    currentLayer.objects.push({
                                        type: 'W',
                                        points
                                    });
                                }
                                break;
                        }
                    }
                }
            }
            
            function finishParsing(fileName) {
                if (layers.length === 0) {
                    const defaultLayer = {
                        id: 0,
                        name: "Default",
                        objects: []
                    };
                    layers.push(defaultLayer);
                    activeLayers.add(defaultLayer.id);
                }
                
                updateLayerList();
                updateFileInfo(fileName);
                fitToScreen();
                draw();
            }
            
            function updateBoundingBox(x, y) {
                boundingBox.minX = Math.min(boundingBox.minX, x);
                boundingBox.maxX = Math.max(boundingBox.maxX, x);
                boundingBox.minY = Math.min(boundingBox.minY, y);
                boundingBox.maxY = Math.max(boundingBox.maxY, y);
            }
            
            // Drawing Functions (remain the same)
            function draw() {
                ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                ctx.save();
                ctx.translate(canvasWidth / 2, canvasHeight / 2);
                ctx.scale(scale, scale);
                ctx.translate(offsetX, offsetY);
                
                if (showGrid) drawGrid();
                drawCIFObjects();
                
                ctx.restore();
                updateZoomIndicator();
            }
            
            function drawGrid() {
                const gridSize = 100;
                const scaledGridSize = gridSize * scale;
                
                if (scaledGridSize < 10) return;
                
                const startX = -canvasWidth / 2 + offsetX;
                const endX = canvasWidth / 2 + offsetX;
                const startY = -canvasHeight / 2 + offsetY;
                const endY = canvasHeight / 2 + offsetY;
                
                const gridStartX = Math.floor(startX / gridSize) * gridSize;
                const gridStartY = Math.floor(startY / gridSize) * gridSize;
                
                ctx.strokeStyle = 'rgba(100, 100, 100, 0.3)';
                ctx.lineWidth = 1 / scale;
                
                for (let x = gridStartX; x <= endX; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, startY);
                    ctx.lineTo(x, endY);
                    ctx.stroke();
                }
                
                for (let y = gridStartY; y <= endY; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(startX, y);
                    ctx.lineTo(endX, y);
                    ctx.stroke();
                }
            }
            
            function drawCIFObjects() {
                layers.forEach((layer, index) => {
                    if (!activeLayers.has(layer.id)) return;
                    
                    const color = layerColors[index % layerColors.length];
                    ctx.fillStyle = color + '80';
                    ctx.strokeStyle = color;
                    ctx.lineWidth = 1 / scale;
                    
                    layer.objects.forEach(obj => {
                        drawObject(obj);
                    });
                });
            }
            
            function drawObject(obj) {
                switch (obj.type) {
                    case 'B':
                        ctx.beginPath();
                        ctx.rect(obj.x, obj.y, obj.width, obj.height);
                        ctx.fill();
                        ctx.stroke();
                        break;
                        
                    case 'P':
                        if (obj.points.length >= 3) {
                            ctx.beginPath();
                            ctx.moveTo(obj.points[0].x, obj.points[0].y);
                            for (let i = 1; i < obj.points.length; i++) {
                                ctx.lineTo(obj.points[i].x, obj.points[i].y);
                            }
                            ctx.closePath();
                            ctx.fill();
                            ctx.stroke();
                        }
                        break;
                        
                    case 'W':
                        if (obj.points.length >= 2) {
                            ctx.beginPath();
                            ctx.moveTo(obj.points[0].x, obj.points[0].y);
                            for (let i = 1; i < obj.points.length; i++) {
                                ctx.lineTo(obj.points[i].x, obj.points[i].y);
                            }
                            ctx.stroke();
                        }
                        break;
                }
            }
            
            // UI Functions (remain the same with PWA updates)
            function toggleLayerSheet() {
                layerSheet.classList.toggle('open');
                updateFileInfoPanel();
            }
            
            function updateLayerList() {
                const layerList = document.getElementById('layer-list');
                layerList.innerHTML = '';
                
                layers.forEach((layer, index) => {
                    const color = layerColors[index % layerColors.length];
                    const isActive = activeLayers.has(layer.id);
                    
                    const layerElement = document.createElement('div');
                    layerElement.className = 'layer-item';
                    layerElement.innerHTML = `
                        <div class="layer-color" style="background-color: ${color}"></div>
                        <div class="layer-info">
                            <div class="layer-name">${layer.name}</div>
                            <div class="layer-stats">${layer.objects.length} objects</div>
                        </div>
                        <div class="layer-toggle ${isActive ? 'active' : ''}" data-layer-id="${layer.id}"></div>
                    `;
                    
                    layerElement.querySelector('.layer-toggle').addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleLayerVisibility(layer.id);
                    });
                    
                    layerList.appendChild(layerElement);
                });
            }
            
            function toggleLayerVisibility(layerId) {
                if (activeLayers.has(layerId)) {
                    activeLayers.delete(layerId);
                } else {
                    activeLayers.add(layerId);
                }
                
                updateLayerList();
                draw();
            }
            
            function updateFileInfo(fileName) {
                document.getElementById('file-name').textContent = fileName || 'None';
                document.getElementById('total-objects').textContent = 
                    layers.reduce((sum, layer) => sum + layer.objects.length, 0);
                document.getElementById('total-layers').textContent = layers.length;
                document.getElementById('file-info-panel').style.display = 'block';
            }
            
            function updateFileInfoPanel() {
                document.getElementById('current-zoom').textContent = `${Math.round(scale * 100)}%`;
                
                // Update PWA status
                if (isStandalone) {
                    document.getElementById('app-mode').textContent = 'PWA Mode';
                } else if (isPWAInstalled) {
                    document.getElementById('app-mode').textContent = 'Installed';
                } else {
                    document.getElementById('app-mode').textContent = 'Browser';
                }
            }
            
            function updateCoordinateDisplay(e) {
                let clientX, clientY;
                
                if (e.type.startsWith('touch')) {
                    const touch = e.touches[0];
                    clientX = touch.clientX;
                    clientY = touch.clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                const rect = canvas.getBoundingClientRect();
                const x = clientX - rect.left;
                const y = clientY - rect.top;
                
                const worldX = (x - canvasWidth/2) / scale - offsetX;
                const worldY = (y - canvasHeight/2) / scale - offsetY;
                
                document.getElementById('coordinate-display').textContent = 
                    `X: ${worldX.toFixed(2)}, Y: ${worldY.toFixed(2)}`;
            }
            
            function updateZoomIndicator() {
                document.getElementById('zoom-indicator').textContent = 
                    `Zoom: ${Math.round(scale * 100)}%`;
            }
            
            // View Control Functions (remain the same)
            function fitToScreen() {
                if (boundingBox.maxX <= boundingBox.minX || boundingBox.maxY <= boundingBox.minY) {
                    resetView();
                    return;
                }
                
                const contentWidth = boundingBox.maxX - boundingBox.minX;
                const contentHeight = boundingBox.maxY - boundingBox.minY;
                const centerX = (boundingBox.minX + boundingBox.maxX) / 2;
                const centerY = (boundingBox.minY + boundingBox.maxY) / 2;
                
                const padding = 0.1;
                const scaleX = canvasWidth / (contentWidth * (1 + padding));
                const scaleY = canvasHeight / (contentHeight * (1 + padding));
                
                scale = Math.min(scaleX, scaleY, maxScale);
                offsetX = -centerX;
                offsetY = -centerY;
                
                draw();
            }
            
            function resetView() {
                scale = 1.0;
                offsetX = 0;
                offsetY = 0;
                draw();
            }
            
            function toggleGrid() {
                showGrid = !showGrid;
                document.getElementById('btn-toggle-grid').textContent = showGrid ? '‚èπÔ∏è' : '‚¨ú';
                draw();
            }
            
            // Fullscreen Functions (remain the same)
            function toggleFullscreen() {
                if (!isFullscreen) {
                    enterFullscreen();
                } else {
                    exitFullscreen();
                }
            }
            
            function enterFullscreen() {
                const element = appContainer;
                
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.mozRequestFullScreen) {
                    element.mozRequestFullScreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            }
            
            function exitFullscreen() {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
            
            function handleFullscreenChange() {
                isFullscreen = !!(document.fullscreenElement || 
                                document.webkitFullscreenElement || 
                                document.mozFullScreenElement || 
                                document.msFullscreenElement);
                
                if (isFullscreen) {
                    appContainer.classList.add('fullscreen');
                    document.getElementById('btn-toggle-fullscreen').style.display = 'flex';
                } else {
                    appContainer.classList.remove('fullscreen');
                    document.getElementById('btn-toggle-fullscreen').style.display = 'none';
                }
                
                setupCanvas();
            }
            
            // Help Functions (remain the same)
            function checkFirstTimeUser() {
                const hasSeenHelp = localStorage.getItem('klayout-mobile-help-seen');
                if (!hasSeenHelp) {
                    touchOverlay.classList.remove('hidden');
                }
            }
            
            function showHelp() {
                touchOverlay.classList.remove('hidden');
            }
            
            function hideHelp() {
                touchOverlay.classList.add('hidden');
                localStorage.setItem('klayout-mobile-help-seen', 'true');
            }
            
            // Utility Functions (remain the same)
            function handleResize() {
                setupCanvas();
                if (cifData) {
                    draw();
                }
            }
            
            function loadSampleData() {
                const sampleCIF = `# Sample CIF file for demonstration
L METAL1;
B 100 50 0 0;
B 50 100 150 0;
P 4 0 200 50 200 50 250 0 250;
W 3 200 0 250 50 200 100;
L POLY;
B 80 80 50 50;
P 3 300 0 350 50 300 100;
L CONTACT;
B 20 20 120 120;
B 20 20 180 180;
# End of sample file`;
                
                parseCIF(sampleCIF, 'sample.cif');
                updateFileInfo('sample.cif');
            }
            
            // Initialize the application
            init();
        });
    </script>
</body>
</html>
